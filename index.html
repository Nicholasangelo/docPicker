<!doctype html>
<html lang="en">
  <head>
    <title>File Picker Stub</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script type="text/javascript" src="https://unpkg.com/@bloomreach/ui-extension@14.2.1/dist/ui-extension.min.js"></script>

    <style>
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .gallery {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .gallery.-hidden {
        display: none;
      }
      .row {
        display: flex;
        flex-direction: row;
      }
      .asset-list {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .asset-list div {
        padding: 6px;
        transition: .5s;
        filter: drop-shadow(0px 0px 0px gray);
        overflow: hidden;
      }
      .asset-list div:hover {
        transition: .5s;
        filter: drop-shadow(0px 0px 15px darkgray);
        transform: scale(0.9);
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="gallery -hidden">
        <div class="row">
          <div class="col-md-6 col-md-offset-3">
            <h1> PICKER </h1>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 col-md-offset-3">
            <h2> Menu </h2>
          </div>
        </div>
        <div class="row">
          <section>
            <div class="asset-list">

            </div>
          </section>
        </div>
      </div>
      <div class="dialog">
        <button id="toggle-dialog">Select assets</button>
        <div class="selected-assets"></div>
    </div>

    <script src="https://unpkg.com/@bloomreach/ui-extension@14.4.0/dist/ui-extension.min.js"></script>
    <script type="text/javascript">
      ((ui, mode) => {
      const gallery = document.querySelector('.gallery');
      // const toggleGallery = () => gallery.classList.contains('-hidden') ? gallery.classList.remove('-hidden') : gallery.classList.add('-hidden');
      const ImageActions = {
        Added: 'added',
        Removed: 'removed',
        None: 'none',
      };
      
      const deserialize = (value) => {
        return (value && JSON.parse(value)) || '';
      }
      
      const serialize = (value) => {
        return value.length ? JSON.stringify(value) : '';
      }

      async function init() {
        try {
        ui = await UiExtension.register();
          ({ mode } = await ui.document.get());
          toggleDialog();
          createGalleryView();
        } catch(error) {
          console.error('failed to register extension', error.message);
          console.error('-error code', error.code);
        }
      }

      const toggleDialog = () => {
        const toggleBtn = document.querySelector('#toggle-dialog');
        if (mode !== 'edit') {
          toggleBtn.style.display = 'none';
          return;
        }
        
        const dialogOptions = {
        title: 'filePicker',
        url: './dialog.html',
        value: '',
      };

      toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openDialog(dialogOptions);
      })  
    }
        
      const openDialog = async (options) => {
        try {
          const currentValue = await ui.document.field.getValue();
          options.value = currentValue;
          const newValue = await ui.dialog.open(options);
          await ui.document.field.setValue(newValue);
          await updatePreview();
        } catch (err) {
          if (err.code === 'DialogCanceled') return;
          console.error('Error after opening dialog ', err.code, err.message);
        }
      }

      const updatePreview = async () => {
        const previewBox = document.querySelector('.selected-assets');
          previewBox.innerHTML = '';

          const docFieldValue = await ui.document.field.getValue();
          console.log('docField ', docFieldValue)
          const image = deserialize(docFieldValue);
console.log('des-image', image)
console.log('mode', mode)
          if (mode === 'compare') {
            const docFieldValueCompare = await ui.document.field.getCompareValue();
            const compare = deserialize(docFieldValueCompare);
            if (compare === image && image !== '') makeThumbnail(ImageActions.None, previewBox, image);
            else {
              if (compare !== '') makeThumbnail(ImageActions.Removed, previewBox, compare);
              if (image !== '') makeThumbnail(ImageActions.Added, previewBox, image);
            }
            return;
          }

          if (image !== '') makeThumbnail(ImageActions.None, previewBox, image);
        }

        const makeThumbnail = (action, container, image) => {
          const img = document.createElement('img');
          img.className = 'image';
          img.src = image.urls.thumb;

          if (mode === 'edit') {
            img.classList.add('image__editing');
            img.addEventListener('click', async () => {
              await removeImage(image);
              container.removeChild(img);
            });
          }

          if (mode === 'compare') {
            img.classList.add({
              [ImageActions.Added]: 'image__added',
              [ImageActions.Removed]: 'image__removed',
              [ImageActions.None]: 'image__unchanged',
            }[actions]);
          }

          container.appendChild(img);
        }
      
      const cancelSelect = async () => {
        await ui.document.field.setValue(null);
      }

      const createGalleryView = () => {
        if (gallery) {
      fetch('https://api.unsplash.com/photos?client_id=d3OVNNPZ5qCwRx4FNLivfnuODMLoka9LZ7o0jNCpVjM')
        .then(response => {
          return response.json();
        })
        .then(data => {
          data.forEach((d, i) => {
            if (i < 10) {
              const imageContainer = document.querySelector('.asset-list');
              const imageDiv = document.createElement('div');
              imageDiv.dataset.id = d.id;
              imageDiv.innerHTML = `<img height='300'  width='300' src=${d.urls.thumb} />`
              imageContainer.appendChild(imageDiv);
            } else {
              return;
            };
          })
        })
        }
      }

        const removeImage = async () => {
          await ui.document.field.setValue('');
        }
     

      document.addEventListener('DOMContentLoaded', init);
      //document.addEventListener('DOMContentLoaded', async () => {
      //  try {
      //    const ui = await UiExtension.register();
      //    const brDocument = await ui.document.get();
      //    const value = await ui.document.field.getValue();

      //    "showFieldValue(value);
      //    "initSetFieldValueButton(ui, brDocument.mode);

      //  } catch (error) {
      //    console.log('failed to register extension', error.message);
      //    console.log('- error code: ', error.code);
      //  };
     // };
      })();
    </script>

  </body>
</html>
